<html>
<head>
    <title>Directory App</title>

    <script type="text/javascript">

        function addUser (){

            let name = document.getElementById("name").value
            email = document.getElementById("email").value
            address = document.getElementById("address").value
            number = document.getElementById("number").value
            console.log(name +":"+email+":"+address+":"+number);
            
            let json = {
                'name' : name,
                'email' : email,
                'address': address,
                'number' : number
            }

            makeAjaxCall('POST', json,'/api/v1/user/add',renderSaveContact);

        }


        var handleClickEvent = (event) =>{
        
            let userId = cleanUserId(event.target.id);
            switch(event.target.name){
            case 'Contact' : {
        makeAjaxCall('GET',null,'/api/v1/user/contact/'+userId,renderGetContact)
        break;
        }
        case 'Delete':{

            makeAjaxCall('DELETE',null,'/api/v1/user/contact/'+userId,handleDeleteContact)
            break;
        }
        case 'Update':{
            makeAjaxCall("GET",null,'/api/v1/user/contact/'+userId, renderUpdateContact)
            break;
        }
        case 'Save':{
            
            var name = document.getElementById("inpBox:name:"+userId).value;
            var email = document.getElementById("inpBox:email:"+userId).value;
            var number = document.getElementById("inpBox:number:"+userId).value;
            var address = document.getElementById("inpBox:address:"+userId).value;
            
            var json = {

                'name' : name,
                'email' : email,
                'number' : number,
                'address' : address
            }
            console.log("json data for update : "+json);
            makeAjaxCall("PUT", json, '/api/v1/user/contact/'+userId, renderGetContact)
        }

    
    }
}

renderUpdateContact = (resp) =>{
debugger;
if(!resp.ok)
document.getElementById("view_contact").innerHTML = "failed to fetch user details";
 
document.getElementById("view_contact").innerHTML = " ";


var user = resp.user;

let div = document.getElementById('view_contact');

var nameTxt = document.createTextNode("name : ");
var nameInputBox  = document.createElement('input');
nameInputBox.type = 'text';
nameInputBox.value = user.name;
nameInputBox.id = "inpBox:name:"+user.id;
var namebr = document.createElement('br')
            
var emailTxt = document.createTextNode("email : ");
var emailInputBox  = document.createElement('input');
emailInputBox.id = "inpBox:email:"+user.id;
emailInputBox.type = 'text';
emailInputBox.value = user.email;
var emailbr = document.createElement('br')
            
var addressTxt = document.createTextNode("address : ");
var addressInputBox  = document.createElement('input');
addressInputBox.id = "inpBox:address:"+user.id;
addressInputBox.type = 'text';
addressInputBox.value = user.address;
var addressbr = document.createElement('br')
            
var numberTxt = document.createTextNode("number : ");
var numberInputBox  = document.createElement('input');
numberInputBox.id = "inpBox:number:"+user.id;
numberInputBox.type = 'text';
numberInputBox.value = user.number;
var numberbr = document.createElement('br')
                        
div.appendChild(nameTxt);
div.appendChild(nameInputBox);
div.appendChild(namebr);

div.appendChild(emailTxt);
div.appendChild(emailInputBox);
div.appendChild(emailbr);

div.appendChild(addressTxt);
div.appendChild(addressInputBox);
div.appendChild(addressbr);

div.appendChild(numberTxt);
div.appendChild(numberInputBox);
div.appendChild(numberbr);

var saveBtn = document.createElement('button')
var saveBtnTxt = document.createTextNode('SAVE');
saveBtn.appendChild(saveBtnTxt);
saveBtn.name = "Save";
saveBtn.id = "saveBtn:"+user.id;
 
var br = document.createElement('br')
div.appendChild(br);
div.appendChild(saveBtn);

document.getElementById("saveBtn:"+user.id).addEventListener('click',handleClickEvent)

}


function handleDeleteContact(resp){
    if(resp.ok){
        document.getElementById("view_contact").innerHTML = "contact deleted successfully !!";
        renderGetContacts(resp)
    }

}
function renderGetContact(resp){

            console.log(resp);

            if(resp.ok){}
            var user = resp.user;

            document.getElementById("view_contact").innerHTML = " ";
            let div = document.getElementById('view_contact');
            
            var name = document.createTextNode("name : ");
            var nameValue = document.createTextNode(user.name);
            var namebr = document.createElement('br')
            
            var email = document.createTextNode("email : ");
            var emailValue = document.createTextNode(user.email);
            var emailbr = document.createElement('br')
            
            var address = document.createTextNode("address : ");
            var addressValue = document.createTextNode(user.address);
            var addressbr = document.createElement('br')
            
            var number = document.createTextNode("number : ");
            var numberValue = document.createTextNode(user.number);
            var numberbr = document.createElement('br')
            

        div.appendChild(name);
        div.appendChild(nameValue);
        div.appendChild(namebr);

        div.appendChild(email);
        div.appendChild(emailValue);
        div.appendChild(emailbr);

        div.appendChild(address);
        div.appendChild(addressValue);
        div.appendChild(addressbr);

        div.appendChild(number);
        div.appendChild(numberValue);
        div.appendChild(numberbr);

        var br = document.createElement('br')
        div.appendChild(br);

        var deleteButton = document.createElement('button');
        deleteButton.id = "delBtn:"+user.id;
        deleteButton.name = "Delete";
        var delBtnTxt = document.createTextNode("DELETE");
        deleteButton.appendChild(delBtnTxt);

        var updateBtn = document.createElement('button');
        updateBtn.id = "updBtn:"+user.id;
        updateBtn.name = "Update";
        var updateBtntxt = document.createTextNode("UPDATE");
        updateBtn.appendChild(updateBtntxt);
        updateBtn.setAttribute =
        div.appendChild(deleteButton);
        document.getElementById("delBtn:"+user.id).addEventListener('click', handleClickEvent)
        
        div.appendChild(updateBtn)

        document.getElementById("updBtn:"+user.id).addEventListener('click',handleClickEvent)
        
        }


        function renderGetContacts(resp){
            if(resp.ok){
                console.log("lenght of contacts fetched for user : "+resp.users.length);
                var contacts_panel = document.getElementById('contacts_panel');
                if(resp.users.length == 0)
                contacts_panel.innerHTML = "No Contact found";
                console.log(resp)
             
                contacts_panel.innerHTML = " ";
                var save_contact_panel = document.getElementById("save_contact_panel");
       save_contact_panel.style.display = "none";
                
      
    
             resp.users.forEach(user => {
                
                 var userButton = document.createElement('button');
                 userButton.id = "contactBtn:"+user.id;
                 userButton.name = "Contact"
                 var btnText = document.createTextNode(user.name);       
                 userButton.appendChild(btnText);    
                 contacts_panel.appendChild(userButton);  
                 var b1 = document.createElement('br');
                 var b2 = document.createElement('br');
                 contacts_panel.appendChild(b1); 
                 contacts_panel.appendChild(b2);       
                document.body.appendChild(contacts_panel);
                
                document.getElementById("contactBtn:"+ user.id).addEventListener('click', handleClickEvent);
            
             });
            } else
          document.getElementById("msg").innerHTML = "failed to get contacts !!";
        }

        function renderSaveContact(resp){

console.log(resp);
      if(resp.ok)
     document.getElementById("msg").innerHTML = "successfully added !!";
     else
     document.getElementById("msg").innerHTML = "failed to added !!";
          
       }

        function getContacts(){

            makeAjaxCall("GET",null,'/api/v1/user/contacts',renderGetContacts)
        }

        function makeAjaxCall(method, dataPayload, path,callback){

 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      resp =   JSON.parse(this.responseText);
      console.log("resp : "+resp);
    callback(resp);
        
    }
    else{
    document.getElementById("msg").innerHTML = " ";
    }
  };


  xhttp.open(method, "http://localhost:3033"+path, true);

  if(dataPayload){
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send(JSON.stringify(dataPayload));
}else{
xhttp.send();
}
        }


        ///// utility methods

       function cleanUserId(userIdWithPattern){

        console.log('userId with pattern : '+userIdWithPattern);

        var res = userIdWithPattern.split(":");
        return res[1];
       }

    </script>
</head>
<body>


    <H1>  Contact App</H1>

<div id="msg"></div>
<div id="save_contact_panel">
   Name <input type="text" id="name"><br>
   Email <input type="text" id="email"><br>
   Address <input type="text" id="address"><br>
   Contact Number <input type="text" id="number"><br><br>

    <button onclick="addUser()">Save Contact</button>
<button onclick="getContacts()">My Contacts</button></div>
<div id='contacts_panel' style="width: 20%" ></div>
<a href='/'>back</a>
<div id="view_contact" style= "margin-right: 50%; float:right; margin-top:95px" ></div>
</body>
</html>
